name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write

env:
  AZURE_RESOURCE_GROUP: camilo-personal-assistant-rg
  DOTNET_VERSION: '10.0.x'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: 'preview'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      
    - name: Run tests
      run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"
      
    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Publish application
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: dotnet publish AIPersonalAssistant.Web/AIPersonalAssistant.Web.csproj --configuration Release --output ./publish --no-build
      
    - name: Upload artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: webapp
        path: ./publish
        retention-days: 1

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: 
      name: production
      url: ${{ steps.deploy.outputs.webAppUrl }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: Deploy Bicep template
      id: deploy
      uses: azure/arm-deploy@v2
      with:
        scope: resourcegroup
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infrastructure/main.bicep
        parameters: ./infrastructure/parameters.json
        failOnStdErr: false

    outputs:
      webAppName: ${{ steps.deploy.outputs.webAppName }}
      webAppUrl: ${{ steps.deploy.outputs.webAppUrl }}

  deploy-app:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ needs.deploy-infrastructure.outputs.webAppUrl }}
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp
        path: ./publish
        
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Configure Application Settings in Azure App Service
      run: |
        az webapp config appsettings set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ needs.deploy-infrastructure.outputs.webAppName }} \
          --settings \
            "AzureAd__ClientId=${{ secrets.AZUREAD_CLIENT_ID }}" \
            "AzureAd__ClientSecret=${{ secrets.AZUREAD_CLIENT_SECRET }}" \
            "AzureAd__TenantId=${{ secrets.AZUREAD_TENANT_ID }}" \
            "ExchangeRateAPIs__ExchangeRateApi__ApiKey=${{ secrets.EXCHANGERATE_API_KEY }}" \
            "ExchangeRateAPIs__OpenExchangeRates__ApiKey=${{ secrets.OPENEXCHANGERATES_API_KEY }}" \
            "ExchangeRateAPIs__CurrencyApi__ApiKey=${{ secrets.CURRENCYAPI_KEY }}" \
            "StockAPI__AlphaVantage__ApiKey=${{ secrets.ALPHAVANTAGE_API_KEY }}" \
            "AzureDocumentIntelligence__Endpoint=${{ secrets.AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT }}" \
            "AzureDocumentIntelligence__ApiKey=${{ secrets.AZURE_DOCUMENT_INTELLIGENCE_API_KEY }}" \
            "Google__ClientId=${{ secrets.GOOGLE_CLIENT_ID }}" \
            "Google__ClientSecret=${{ secrets.GOOGLE_CLIENT_SECRET }}"
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.webAppName }}
        package: ./publish
    
    - name: Display deployment URL
      run: |
        echo "‚úÖ Application deployed successfully!"
        echo "üåê URL: ${{ needs.deploy-infrastructure.outputs.webAppUrl }}"

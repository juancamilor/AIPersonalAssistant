# GitHub Secrets Setup for CI/CD

## Overview
The CI/CD pipeline automatically configures all application settings (Azure AD authentication + API keys) in Azure App Service during deployment. You need to add these secrets to GitHub **one time only**.

## ‚ö†Ô∏è KEY REGISTRY ‚Äî Master Reference

When adding ANY new API key to the application, ALL of these places MUST be updated:

| Config Key (appsettings) | User Secrets Command | GitHub Secret Name | ci.yml | deploy.yml |
|---|---|---|---|---|
| `AzureAd:ClientId` | `dotnet user-secrets set "AzureAd:ClientId" "value"` | `AZUREAD_CLIENT_ID` | ‚úÖ Line 124 | ‚úÖ Line 96 |
| `AzureAd:ClientSecret` | `dotnet user-secrets set "AzureAd:ClientSecret" "value"` | `AZUREAD_CLIENT_SECRET` | ‚úÖ Line 125 | ‚úÖ Line 97 |
| `AzureAd:TenantId` | `dotnet user-secrets set "AzureAd:TenantId" "value"` | `AZUREAD_TENANT_ID` | ‚úÖ Line 126 | ‚úÖ Line 98 |
| `ExchangeRateAPIs:ExchangeRateApi:ApiKey` | `dotnet user-secrets set "ExchangeRateAPIs:ExchangeRateApi:ApiKey" "value"` | `EXCHANGERATE_API_KEY` | ‚úÖ Line 127 | ‚úÖ Line 99 |
| `ExchangeRateAPIs:OpenExchangeRates:ApiKey` | `dotnet user-secrets set "ExchangeRateAPIs:OpenExchangeRates:ApiKey" "value"` | `OPENEXCHANGERATES_API_KEY` | ‚úÖ Line 128 | ‚úÖ Line 100 |
| `ExchangeRateAPIs:CurrencyApi:ApiKey` | `dotnet user-secrets set "ExchangeRateAPIs:CurrencyApi:ApiKey" "value"` | `CURRENCYAPI_KEY` | ‚úÖ Line 129 | ‚úÖ Line 101 |
| `StockAPI:AlphaVantage:ApiKey` | `dotnet user-secrets set "StockAPI:AlphaVantage:ApiKey" "value"` | `ALPHAVANTAGE_API_KEY` | ‚úÖ Line 130 | ‚úÖ Line 102 |

### üö® Mandatory Checklist for Adding a New API Key

When adding ANY new service that requires an API key:

- [ ] Add placeholder in `appsettings.json`
- [ ] Add `dotnet user-secrets set` command to SECURITY.md and relevant setup doc
- [ ] Create GitHub Secret in repository settings
- [ ] Add to `.github/workflows/ci.yml` Configure Application Settings step
- [ ] Add to `.github/workflows/deploy.yml` Configure Application Settings step
- [ ] Add to this KEY REGISTRY table
- [ ] Update DEPLOYMENT.md Environment Variables section
- [ ] Test locally with user-secrets
- [ ] Deploy and verify key reaches production via /api/health endpoint

## Required GitHub Secrets

Add these 7 secrets to your GitHub repository:

### Azure AD Authentication (Runtime)
| Secret Name | Value | Purpose |
|------------|-------|---------|
| `AZUREAD_CLIENT_ID` | `aa7c35d6-dc69-477f-9b83-51236f06b2fe` | Azure AD App for user authentication |
| `AZUREAD_CLIENT_SECRET` | `SYB8Q~***SECRET***` | Azure AD App secret (see Azure Portal) |
| `AZUREAD_TENANT_ID` | `common` | For personal Microsoft accounts |

### Exchange Rate APIs
| Secret Name | Value | Purpose |
|------------|-------|---------|
| `EXCHANGERATE_API_KEY` | `acd35787f895deee3418db8c` | ExchangeRate-API.com |
| `OPENEXCHANGERATES_API_KEY` | `bd67a76a53d342c1bfa9a7b1312687b9` | Open Exchange Rates |
| `CURRENCYAPI_KEY` | `cur_live_LGNfQAz7gukb6lwIDlvxqm5HQtu8hZdAMAYTTuJB` | CurrencyAPI.com |

### Stock Tools API
| Secret Name | Value | Purpose |
|------------|-------|---------|
| `ALPHAVANTAGE_API_KEY` | `YOUR_ALPHAVANTAGE_KEY` | Alpha Vantage stock data |

**Note:** Azure Storage connection string is auto-generated by Bicep and does not require a GitHub secret.

## How to Add Secrets to GitHub

### Step 1: Go to Repository Settings
1. Open your browser and go to: https://github.com/juancamilor/AIPersonalAssistant
2. Click the **Settings** tab (at the top of the page)

### Step 2: Navigate to Secrets
1. In the left sidebar, click **Secrets and variables**
2. Click **Actions**

### Step 3: Add Each Secret
For each secret in the table above:

1. Click the **"New repository secret"** button (green button, top right)
2. Fill in the form:
   - **Name:** Copy the exact name from the "Secret Name" column (e.g., `AZUREAD_CLIENT_ID`)
   - **Secret:** Copy the value from the "Value" column
3. Click **"Add secret"**
4. Repeat for all 7 secrets

### Visual Guide

```
Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
```

**Example:**
```
Name: AZUREAD_CLIENT_ID
Secret: aa7c35d6-dc69-477f-9b83-51236f06b2fe
[Add secret]
```

## What Happens After Adding Secrets?

Once you add the secrets:
1. ‚úÖ Both ci.yml and deploy.yml workflows automatically configure all settings in Azure App Service
2. ‚úÖ Settings are synced after every deployment (automatic configuration step)
3. ‚úÖ No manual steps needed after deployment
4. ‚úÖ Keys are encrypted and secure in GitHub
5. ‚úÖ Only GitHub Actions can access them

## Testing

After adding the secrets:
1. Push any change to `main` branch (or manually trigger deploy.yml workflow)
2. GitHub Actions will:
   - ‚úÖ Build and test the app (ci.yml only)
   - ‚úÖ Deploy infrastructure (ci.yml only)
   - ‚úÖ Deploy application (both workflows)
   - ‚úÖ **Automatically configure Azure AD authentication + API keys in Azure** (both workflows)
3. Visit your Azure app and test the Exchange Rate tool
4. Click "View Details" - you should see all 3 sources with green checkmarks ‚úì

**Note:** Both `ci.yml` (push to main) and `deploy.yml` (manual trigger) will configure settings automatically.

## Updating API Keys

If you need to rotate/update API keys:
1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions
2. Click on the secret name
3. Click "Update secret"
4. Enter new value
5. Next deployment will use the new key automatically

## Security Notes

- ‚úÖ Secrets are **encrypted** in GitHub
- ‚úÖ Secrets **never appear** in logs
- ‚úÖ Only repository admins can add/view secrets
- ‚úÖ GitHub Actions can only **use** them (not view)
- ‚úÖ Secrets are **not** committed to Git

## Already Configured Secrets

Your repository should already have these Azure secrets configured:
- `AZURE_CLIENT_ID` - Service principal for GitHub Actions deployment
- `AZURE_TENANT_ID` - Your Azure tenant ID
- `AZURE_SUBSCRIPTION_ID` - Your Azure subscription ID

You're adding the 7 new secrets listed above (3 for Azure AD authentication + 3 for Exchange Rate APIs + 1 for Stock Tools).

## Need Help?

If you encounter issues:
1. Verify secret names are **exactly** as shown (case-sensitive)
2. Check there are no extra spaces in the values
3. Ensure you're in the **Actions** secrets section (not Dependabot or Codespaces)

## Next Steps

After adding secrets:
1. ‚úÖ Commit and push the updated workflow
2. ‚úÖ GitHub Actions will deploy automatically
3. ‚úÖ API keys will be configured in Azure
4. ‚úÖ Test the Exchange Rate tool
